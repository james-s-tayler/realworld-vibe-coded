#!/bin/sh
# Cross-platform pre-commit hook that runs appropriate lint targets based on changed files

# Get list of staged files
staged_files=$(git diff --cached --name-only)

# Check if there are any changes in App/Server
server_changes=$(echo "$staged_files" | grep "^App/Server/" | wc -l)

# Check if there are any changes in App/Client
client_changes=$(echo "$staged_files" | grep "^App/Client/" | wc -l)

# Check if there are any changes in Task/Runner
task_runner_changes=$(echo "$staged_files" | grep "^Task/Runner/" | wc -l)

# Check if there are any changes in Task/FlowPilot
task_flowpilot_changes=$(echo "$staged_files" | grep "^Task/FlowPilot/" | wc -l)

# Check if there are any changes in Test/e2e
e2e_test_changes=$(echo "$staged_files" | grep "^Test/e2e/" | wc -l)

# Check if there are any changes in Server.Infrastructure/Data or Server.Core
migration_changes=$(echo "$staged_files" | grep -E "^App/Server/src/Server\.(Infrastructure/Data|Core)/" | wc -l)

# Run lint-server-fix if there are server changes
if [ "$server_changes" -gt 0 ]; then
  echo "ğŸ”§ Server changes detected, running lint-server-verify..."
  if ! ./build.sh lint-server-verify; then
    echo "âŒ Server linting failed. Run nuke LintServerFix to try and fix the issues."
    exit 1
  fi
  echo "âœ… Server linting completed successfully."
fi

# Run lint-client-fix if there are client changes
if [ "$client_changes" -gt 0 ]; then
  echo "ğŸ”§ Client changes detected, running lint-client-verify..."
  if ! ./build.sh lint-client-verify; then
    echo "âŒ Client linting failed. Run nuke LintClientFix to try and fix the issues."
    exit 1
  fi
  echo "âœ… Client linting completed successfully."
fi

# Run lint-nuke-fix if there are Task/Runner changes
if [ "$task_runner_changes" -gt 0 ]; then
  echo "ğŸ”§ Task/Runner changes detected, running lint-nuke-verify..."
  if ! ./build.sh lint-nuke-verify; then
    echo "âŒ Nuke linting failed. Run nuke LintNukeFix to try and fix the issues."
    exit 1
  fi
  echo "âœ… Nuke linting completed successfully."
fi

# Run test-flowpilot if there are FlowPilot changes
if [ "$task_flowpilot_changes" -gt 0 ]; then
  echo "ğŸ”§ Task/FlowPilot changes detected, running TestFlowPilot..."
  if ! ./build.sh TestFlowPilot; then
    echo "âŒ FlowPilot tests failed."
    exit 1
  fi
  echo "âœ… FlowPilot tests completed successfully."
fi

# E2E tests are intentionally not run in pre-commit hook (too time-consuming)
# Run them manually with: ./build.sh TestE2e
if [ "$e2e_test_changes" -gt 0 ]; then
  echo "â„¹ï¸  Test/e2e changes detected. E2E tests are not run in pre-commit hook."
  echo "   Run them manually with: ./build.sh TestE2e"
fi

# Run DbMigrationsVerifyAll if there are changes in Server.Infrastructure/Data or Server.Core
if [ "$migration_changes" -gt 0 ]; then
  echo "ğŸ”§ Database migration or Core entity changes detected, running DbMigrationsVerifyAll..."
  if ! ./build.sh DbMigrationsVerifyAll; then
    echo "âŒ Database migrations verification failed. Run ./build.sh DbMigrationsGenerateIdempotentScript to regenerate the script."
    exit 1
  fi
  echo "âœ… Database migrations verification completed successfully."
fi

# If no relevant changes, skip linting
if [ "$server_changes" -eq 0 ] && [ "$client_changes" -eq 0 ] && [ "$task_runner_changes" -eq 0 ] && [ "$task_flowpilot_changes" -eq 0 ] && [ "$e2e_test_changes" -eq 0 ] && [ "$migration_changes" -eq 0 ]; then
  echo "â„¹ï¸  No changes detected in App/Server, App/Client, Task/Runner, Task/FlowPilot, Test/e2e, or database migration directories. Skipping linting."
fi

# Run flowpilot lint to ensure FlowPilot plan state is valid
echo "ğŸ”§ Running flowpilot lint..."
if ! flowpilot lint; then
  echo "âŒ FlowPilot lint failed. Please fix the FlowPilot plan state."
  exit 1
fi
echo "âœ… FlowPilot lint completed successfully."

echo "ğŸ‰ Pre-commit hook completed successfully."
