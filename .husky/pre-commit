#!/bin/sh
# Cross-platform pre-commit hook that runs appropriate lint targets based on changed files

# Get list of staged files
staged_files=$(git diff --cached --name-only)

# Check if there are any changes in App/Server
server_changes=$(echo "$staged_files" | grep "^App/Server/" | wc -l)

# Check if there are any changes in App/Client
client_changes=$(echo "$staged_files" | grep "^App/Client/" | wc -l)

# Check if there are any changes in Task/Runner  
task_runner_changes=$(echo "$staged_files" | grep "^Task/Runner/" | wc -l)

# Run lint-server-fix if there are server changes
if [ "$server_changes" -gt 0 ]; then
  echo "ğŸ”§ Server changes detected, running lint-server-fix..."
  if ! ./build.sh lint-server-fix; then
    echo "âŒ Server linting failed. Please fix the issues and try again."
    exit 1
  fi
  echo "âœ… Server linting completed successfully."
fi

# Run lint-client-fix if there are client changes
if [ "$client_changes" -gt 0 ]; then
  echo "ğŸ”§ Client changes detected, running lint-client-fix..."
  if ! ./build.sh lint-client-fix; then
    echo "âŒ Client linting failed. Please fix the issues and try again."
    exit 1
  fi
  echo "âœ… Client linting completed successfully."
fi

# Run lint-nuke-fix if there are Task/Runner changes
if [ "$task_runner_changes" -gt 0 ]; then
  echo "ğŸ”§ Task/Runner changes detected, running lint-nuke-fix..."
  if ! ./build.sh lint-nuke-fix; then
    echo "âŒ Nuke linting failed. Please fix the issues and try again."
    exit 1
  fi
  echo "âœ… Nuke linting completed successfully."
fi

# If no relevant changes, skip linting
if [ "$server_changes" -eq 0 ] && [ "$client_changes" -eq 0 ] && [ "$task_runner_changes" -eq 0 ]; then
  echo "â„¹ï¸  No changes detected in App/Server, App/Client, or Task/Runner directories. Skipping linting."
fi

echo "ğŸ‰ Pre-commit hook completed successfully."
