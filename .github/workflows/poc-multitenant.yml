name: POC Multi-Tenant Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Cancel in-progress runs for the same ref/PR to save minutes
concurrency:
  group: poc-multitenant-ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  # Detect changes to POC paths
  changes:
    name: changes
    runs-on: ubuntu-latest
    outputs:
      poc_multitenant: ${{ steps.filter.outputs.poc_multitenant }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for path changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            poc_multitenant:
              - 'Task/PoC/MultiTenantPocApi/**'

  test-poc-multitenant:
    name: test-poc-multitenant
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.poc_multitenant == 'true' }}
    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
    steps:
      - name: Explain skip
        if: ${{ needs.changes.outputs.poc_multitenant != 'true' }}
        run: echo "No POC MultiTenant changes detected; skipping POC tests."

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET (from global.json)
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: App/Server/global.json

      - name: Verify .NET version
        run: dotnet --info

      - name: Restore POC dependencies
        run: dotnet restore Task/PoC/MultiTenantPocApi/MultiTenantPocApi.FunctionalTests/MultiTenantPocApi.FunctionalTests.csproj

      - name: Build POC API
        run: dotnet build Task/PoC/MultiTenantPocApi/MultiTenantPocApi/MultiTenantPocApi.csproj --no-restore

      - name: Build POC Tests
        run: dotnet build Task/PoC/MultiTenantPocApi/MultiTenantPocApi.FunctionalTests/MultiTenantPocApi.FunctionalTests.csproj --no-restore

      - name: Run POC Functional Tests
        id: poc_tests
        run: |
          set +e  # Don't exit on error
          dotnet test Task/PoC/MultiTenantPocApi/MultiTenantPocApi.FunctionalTests/MultiTenantPocApi.FunctionalTests.csproj \
            --no-build \
            --verbosity normal \
            --logger "console;verbosity=detailed" \
            --logger "trx;LogFileName=test-results.trx"
          TEST_EXIT_CODE=$?
          echo "exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
          exit 0  # Always succeed so we can upload artifacts and comment

      - name: Generate test report
        if: always()
        run: |
          mkdir -p Reports/POC/MultiTenantPocApi
          echo "# POC Multi-Tenant Functional Tests" > Reports/POC/MultiTenantPocApi/Report.md
          echo "" >> Reports/POC/MultiTenantPocApi/Report.md
          
          if [ ${{ steps.poc_tests.outputs.exit_code }} -eq 0 ]; then
            echo "✅ **All POC tests passed**" >> Reports/POC/MultiTenantPocApi/Report.md
          else
            echo "❌ **POC tests failed**" >> Reports/POC/MultiTenantPocApi/Report.md
          fi
          
          echo "" >> Reports/POC/MultiTenantPocApi/Report.md
          echo "## Test Results" >> Reports/POC/MultiTenantPocApi/Report.md
          echo "" >> Reports/POC/MultiTenantPocApi/Report.md
          
          # Find and display trx file content summary
          if [ -f Task/PoC/MultiTenantPocApi/MultiTenantPocApi.FunctionalTests/TestResults/test-results.trx ]; then
            echo "View detailed test results in uploaded artifacts." >> Reports/POC/MultiTenantPocApi/Report.md
          fi

      - name: Add report to step summary
        if: always()
        run: cat Reports/POC/MultiTenantPocApi/Report.md >> $GITHUB_STEP_SUMMARY

      - name: Comment test results on PR
        if: always() && github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: test-poc-multitenant
          path: Reports/POC/MultiTenantPocApi/Report.md

      - name: Upload POC Test Reports
        uses: actions/upload-artifact@v4
        if: always()  # Upload even if tests failed
        with:
          name: poc-multitenant-test-reports
          path: |
            Task/PoC/MultiTenantPocApi/MultiTenantPocApi.FunctionalTests/TestResults/
            Reports/POC/MultiTenantPocApi/
          retention-days: 7

      - name: Upload POC Logs
        uses: actions/upload-artifact@v4
        if: always()  # Upload even if tests failed
        with:
          name: poc-multitenant-logs
          path: |
            Logs/
          retention-days: 7

      - name: Fail job if tests failed
        if: steps.poc_tests.outputs.exit_code != '0'
        run: |
          echo "POC Multi-Tenant tests failed with exit code ${{ steps.poc_tests.outputs.exit_code }}"
          exit ${{ steps.poc_tests.outputs.exit_code }}
