name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Cancel in-progress runs for the same ref/PR to save minutes
concurrency:
  group: server-ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write
  packages: write

jobs:
  # Detect changes to specific paths to gate downstream jobs
  changes:
    name: changes
    runs-on: ubuntu-latest
    outputs:
      client: ${{ steps.filter.outputs.client }}
      server: ${{ steps.filter.outputs.server }}
      infra: ${{ steps.filter.outputs.infra }}
      task_runner: ${{ steps.filter.outputs.task_runner }}
      task_flowpilot: ${{ steps.filter.outputs.task_flowpilot }}
      test_postman: ${{ steps.filter.outputs.test_postman }}
      test_e2e: ${{ steps.filter.outputs.test_e2e }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for path changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            client:
              - 'App/Client/**'
            server:
              - 'App/Server/**'
            infra:
              - 'Infra/**'
            task_runner:
              - 'Task/Runner/**'
            task_flowpilot:
              - 'Task/FlowPilot/**'
            test_postman:
              - 'Test/Postman/**'
            test_e2e:
              - 'Test/e2e/**'
  build-nuke:
    name: build-nuke
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.task_runner == 'true' }}
    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET (from global.json)
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: App/Server/global.json

      - name: Verify .NET version
        run: dotnet --info

      - name: Build (Nuke build system)
        run: dotnet build Task/Runner/Nuke.sln

  flowpilot-lint:
    name: flowpilot-lint
    runs-on: ubuntu-latest
    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch base branch
        run: git fetch --prune --unshallow origin main:refs/remotes/origin/main

      - name: Setup .NET (from global.json)
        uses: actions/setup-dotnet@v4

      - name: Verify .NET version
        run: dotnet --info

      - name: Build (server)
        run: ./build.sh install-flowpilot

      - name: FlowPilot Lint
        run: flowpilot lint

  build-server:
    name: build-server
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.client == 'true' || needs.changes.outputs.server == 'true' }}
    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET (from global.json)
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: App/Server/global.json

      - name: Verify .NET version
        run: dotnet --info

      - name: Build (server)
        run: ./build.sh build-server

  test-server:
    name: test-server
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.server == 'true' }}
    # Run tests as an independent job so it shows up as its own status check
    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET (from global.json)
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: App/Server/global.json

      - name: Verify .NET version
        run: dotnet --info

      - name: Test (server)
        id: xunit_tests
        run: |
          set +e  # Don't exit on error
          ./build.sh test-server
          TEST_EXIT_CODE=$?
          echo "exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
          exit 0  # Always succeed so we can upload artifacts and comment

      - name: Add full report to step summary
        if: always()
        run: cat Reports/Server/Artifacts/Tests/Report.md >> $GITHUB_STEP_SUMMARY

      - name: Append full report link to ReportSummary.md
        if: always() && github.event_name == 'pull_request'
        run: |
          echo "" >> Reports/Server/Artifacts/Tests/ReportSummary.md
          echo "---" >> Reports/Server/Artifacts/Tests/ReportSummary.md
          echo "ðŸ“„ **[View Full Test Report in Job Summary](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})**" >> Reports/Server/Artifacts/Tests/ReportSummary.md

      - name: Comment test results on PR
        if: always() && github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: test-server
          path: Reports/Server/Artifacts/Tests/ReportSummary.md

      - name: Upload TestServer Reports
        uses: actions/upload-artifact@v4
        if: always()  # Upload even if tests failed
        with:
          name: test-server-reports
          path: |
            Reports/Server/Artifacts
            Reports/Server/Results
          retention-days: 7

      - name: Fail job if tests failed
        if: steps.xunit_tests.outputs.exit_code != '0'
        run: |
          echo "xUnit tests failed with exit code ${{ steps.xunit_tests.outputs.exit_code }}"
          exit ${{ steps.xunit_tests.outputs.exit_code }}

  server-code-coverage-threshold:
    name: server-code-coverage-threshold
    runs-on: ubuntu-latest
    needs: [changes, test-server]
    if: ${{ needs.changes.outputs.server == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download test-server-reports artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-server-reports
          path: Reports/Server

      - name: Server Code Coverage Summary
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: Reports/Server/Artifacts/Coverage/Cobertura.xml
          format: markdown
          output: both
          badge: true
          fail_below_min: true
          thresholds: '85 80'

      - name: Add Coverage PR Comment
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { wrapCoverageComment } = require('./.github/scripts/wrap-coverage-comment.js');
            const { createOrUpdateStickyComment } = require('./.github/scripts/sticky-comment.js');

            const commentBody = wrapCoverageComment(
              'code-coverage-results.md',
              'nuke TestServer Code Coverage',
              context
            );

            if (!commentBody) {
              console.log('No comment body generated, skipping PR comment');
              return;
            }

            await createOrUpdateStickyComment(
              github,
              context,
              'server-code-coverage',
              commentBody
            );

  lint-server-verify:
    name: lint-server-verify
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.server == 'true' }}
    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET (from global.json)
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: App/Server/global.json

      - name: Verify .NET version
        run: dotnet --info

      - name: Lint (server)
        run: ./build.sh lint-server-verify

  db-migrations-verify-all:
    name: db-migrations-verify-all
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.server == 'true' }}
    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET (from global.json)
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: App/Server/global.json

      - name: Verify .NET version
        run: dotnet --info

      - name: Verify all database migrations
        run: ./build.sh db-migrations-verify-all

  lint-nuke-verify:
    name: lint-nuke-verify
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.task_runner == 'true' }}
    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET (from global.json)
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: App/Server/global.json

      - name: Verify .NET version
        run: dotnet --info

      - name: Lint (Nuke build targets)
        run: ./build.sh lint-nuke-verify

  build-client:
    name: build-client
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.client == 'true' || needs.changes.outputs.server == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: App/Client/package-lock.json

      - name: Build (client)
        run: ./build.sh build-client

  test-client:
    name: test-client
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.client == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: App/Client/package-lock.json

      - name: Test (client)
        id: vitest_tests
        run: |
          set +e  # Don't exit on error
          ./build.sh test-client
          TEST_EXIT_CODE=$?
          echo "exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
          exit 0  # Always succeed so we can upload artifacts and comment

      - name: Add full report to step summary
        if: always()
        run: cat Reports/Client/Artifacts/Report.md >> $GITHUB_STEP_SUMMARY

      - name: Append full report link to ReportSummary.md
        if: always() && github.event_name == 'pull_request'
        run: |
          echo "" >> Reports/Client/Artifacts/ReportSummary.md
          echo "---" >> Reports/Client/Artifacts/ReportSummary.md
          echo "ðŸ“„ **[View Full Test Report in Job Summary](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})**" >> Reports/Client/Artifacts/ReportSummary.md

      - name: Comment test results on PR
        if: always() && github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: test-client
          path: Reports/Client/Artifacts/ReportSummary.md

      - name: Upload TestClient Reports
        uses: actions/upload-artifact@v4
        if: always()  # Upload even if tests failed
        with:
          name: test-client-reports
          path: |
            Reports/Client/Artifacts
            Reports/Client/Results
          retention-days: 7

      - name: Fail job if tests failed
        if: steps.vitest_tests.outputs.exit_code != '0'
        run: |
          echo "Client tests failed with exit code ${{ steps.vitest_tests.outputs.exit_code }}"
          exit ${{ steps.vitest_tests.outputs.exit_code }}

  client-code-coverage-threshold:
    name: client-code-coverage-threshold
    runs-on: ubuntu-latest
    needs: [changes, test-client]
    if: ${{ needs.changes.outputs.client == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download test-client-reports artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-client-reports
          path: Reports/Client

      - name: Client Code Coverage Summary
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: Reports/Client/Results/coverage/cobertura-coverage.xml
          format: markdown
          output: both
          badge: true
          fail_below_min: true
          thresholds: '60 80'

      - name: Add Coverage PR Comment
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { wrapCoverageComment } = require('./.github/scripts/wrap-coverage-comment.js');
            const { createOrUpdateStickyComment } = require('./.github/scripts/sticky-comment.js');

            const commentBody = wrapCoverageComment(
              'code-coverage-results.md',
              'nuke TestClient Code Coverage',
              context
            );

            if (!commentBody) {
              console.log('No comment body generated, skipping PR comment');
              return;
            }

            await createOrUpdateStickyComment(
              github,
              context,
              'client-code-coverage',
              commentBody
            );

  lint-client-verify:
    name: lint-client-verify
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.client == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: App/Client/package-lock.json

      - name: Lint (client)
        run: ./build.sh lint-client-verify

  test-server-postman:
    name: test-server-postman-${{ matrix.collection }}
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.server == 'true' || needs.changes.outputs.test_postman == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - collection: articles-empty
            report_dir: ArticlesEmpty
            bail: false
          - collection: articles-empty
            report_dir: ArticlesEmpty
            bail: true
          - collection: auth
            report_dir: Auth
            bail: false
          - collection: auth
            report_dir: Auth
            bail: true
          - collection: profiles
            report_dir: Profiles
            bail: false
          - collection: profiles
            report_dir: Profiles
            bail: true
          - collection: feed-and-articles
            report_dir: FeedAndArticles
            bail: false
          - collection: feed-and-articles
            report_dir: FeedAndArticles
            bail: true
          - collection: article
            report_dir: Article
            bail: false
          - collection: article
            report_dir: Article
            bail: true
    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
      DOCKER_BUILDKIT: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET (from global.json)
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: App/Server/global.json

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Verify .NET version
        run: dotnet --info

      - name: Test Server (Postman - ${{ matrix.collection }}${{ matrix.bail && ' with --bail' || '' }})
        id: postman_tests
        run: |
          set +e  # Don't exit on error
          ./build.sh test-server-postman-${{ matrix.collection }} ${{ matrix.bail && '--bail true' || '' }}
          TEST_EXIT_CODE=$?
          echo "exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
          exit 0  # Always succeed so we can upload artifacts and comment

      - name: Upload Postman Reports
        uses: actions/upload-artifact@v4
        if: always()  # Upload even if tests failed
        with:
          name: postman-test-reports-${{ matrix.collection }}${{ matrix.bail && '-bail' || '' }}
          path: |
            Reports/Test/Postman/${{ matrix.report_dir }}/newman-report.json
          retention-days: 7

      - name: Upload Logs
        uses: actions/upload-artifact@v4
        if: always()  # Upload even if tests failed
        with:
          name: postman-test-logs-${{ matrix.collection }}${{ matrix.bail && '-bail' || '' }}
          path: |
            Logs/
          retention-days: 7

      - name: Parse test results and create PR comment
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { parseNewmanReport } = require('./.github/scripts/newman-report-parser.js');
            const { createOrUpdateStickyComment } = require('./.github/scripts/sticky-comment.js');

            try {
              const collectionName = '${{ matrix.collection }}';
              const reportDir = '${{ matrix.report_dir }}';
              const withBail = ${{ matrix.bail }};
              const reportPath = `Reports/Test/Postman/${reportDir}/newman-report.json`;
              const commentBody = parseNewmanReport(reportPath, context, `(${collectionName})`, withBail);

              if (!commentBody) {
                console.log('No comment body generated, skipping PR comment');
                return;
              }

              // Use sticky comment with unique header per collection and bail status
              const headerSuffix = withBail ? '-bail' : '';
              await createOrUpdateStickyComment(
                github,
                context,
                `postman-test-${collectionName}${headerSuffix}`,
                commentBody
              );

            } catch (error) {
              console.error('Error creating/updating PR comment:', error);
            }

      - name: Fail job if tests failed
        if: steps.postman_tests.outputs.exit_code != '0'
        run: |
          echo "Postman tests failed with exit code ${{ steps.postman_tests.outputs.exit_code }}"
          exit ${{ steps.postman_tests.outputs.exit_code }}

  build-test-e2e:
    name: build-test-e2e
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.server == 'true' || needs.changes.outputs.client == 'true' || needs.changes.outputs.test_e2e == 'true' }}
    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
      DOCKER_BUILDKIT: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET (from global.json)
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: App/Server/global.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: App/Client/package-lock.json

      - name: Build and publish (server + client)
        run: ./build.sh build-server-publish

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Playwright E2E image with cache
        uses: docker/build-push-action@v6
        with:
          context: ./Test/e2e
          file: ./Test/e2e/Dockerfile.playwright
          # Tag must match what docker-compose expects (see below)
          tags: ghcr.io/${{ github.repository }}/playwright:ci
          push: true
          cache-from: |
            type=gha
            type=registry,ref=ghcr.io/${{ github.repository }}/playwright:cache
          cache-to: |
            type=gha,mode=max
            type=registry,ref=ghcr.io/${{ github.repository }}/playwright:cache,mode=max

      - name: Build Api E2E image with cache
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Test/e2e/Dockerfile.api
          # Tag must match what docker-compose expects (see below)
          tags: ghcr.io/${{ github.repository }}/api:ci
          push: true
          cache-from: |
            type=gha
            type=registry,ref=ghcr.io/${{ github.repository }}/api:cache
          cache-to: |
            type=gha,mode=max
            type=registry,ref=ghcr.io/${{ github.repository }}/api:cache,mode=max

  test-e2e:
    name: test-e2e
    runs-on: ubuntu-latest
    needs: [changes, build-test-e2e]
    if: ${{ needs.changes.outputs.server == 'true' || needs.changes.outputs.client == 'true' || needs.changes.outputs.test_e2e == 'true' }}
    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
      DOCKER_BUILDKIT: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET (from global.json)
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: App/Server/global.json

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Test Server (E2E)
        id: e2e_tests
        run: |
          set +e  # Don't exit on error
          ./build.sh test-e2e -skip-publish true
          TEST_EXIT_CODE=$?
          echo "exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
          exit 0  # Always succeed so we can upload artifacts and comment

      - name: Add full report to step summary
        if: always()
        run: cat Reports/Test/e2e/Artifacts/Report.md >> $GITHUB_STEP_SUMMARY

      - name: Append full report link to ReportSummary.md
        if: always() && github.event_name == 'pull_request'
        run: |
          echo "" >> Reports/Test/e2e/Artifacts/ReportSummary.md
          echo "---" >> Reports/Test/e2e/Artifacts/ReportSummary.md
          echo "ðŸ“„ **[View Full Test Report in Job Summary](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})**" >> Reports/Test/e2e/Artifacts/ReportSummary.md

      - name: Comment test results on PR
        if: always() && github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: test-e2e
          path: Reports/Test/e2e/Artifacts/ReportSummary.md

      - name: Upload E2E Test Reports
        uses: actions/upload-artifact@v4
        if: always()  # This should actually be failure(), but I will optimize later
        with:
          name: test-e2e-reports
          path: |
            Reports/Test/e2e
          retention-days: 7

      - name: Fail job if tests failed
        if: steps.e2e_tests.outputs.exit_code != '0'
        run: |
          echo "E2E tests failed with exit code ${{ steps.e2e_tests.outputs.exit_code }}"
          exit ${{ steps.e2e_tests.outputs.exit_code }}

  test-e2e-flake-detection:
    name: test-e2e-flake-detection-${{ matrix.run }}
    runs-on: ubuntu-latest
    needs: [changes, build-test-e2e]
    if: ${{ needs.changes.outputs.test_e2e == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        run: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
      DOCKER_BUILDKIT: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET (from global.json)
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: App/Server/global.json

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Test Server (E2E)
        id: e2e_tests
        run: |
          set +e  # Don't exit on error
          ./build.sh test-e2e -skip-publish true
          TEST_EXIT_CODE=$?
          echo "exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
          exit 0  # Always succeed so we can upload artifacts

      - name: Add full report to step summary
        if: always()
        run: cat Reports/Test/e2e/Artifacts/Report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload E2E Test Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-e2e-flake-detection-${{ matrix.run }}-reports
          path: |
            Reports/Test/e2e
          retention-days: 7

      - name: Fail job if tests failed
        if: steps.e2e_tests.outputs.exit_code != '0'
        run: |
          echo "E2E tests failed with exit code ${{ steps.e2e_tests.outputs.exit_code }}"
          exit ${{ steps.e2e_tests.outputs.exit_code }}

  build-flowpilot:
    name: build-flowpilot
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.task_flowpilot == 'true' }}
    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
    steps:
      - name: Explain skip
        if: ${{ needs.changes.outputs.task_flowpilot != 'true' }}
        run: echo "No FlowPilot changes detected; skipping FlowPilot build."

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET (from global.json)
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: App/Server/global.json

      - name: Verify .NET version
        run: dotnet --info

      - name: Build (FlowPilot)
        run: ./build.sh BuildFlowPilot

  lint-flowpilot-verify:
    name: lint-flowpilot-verify
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.task_flowpilot == 'true' }}
    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
    steps:
      - name: Explain skip
        if: ${{ needs.changes.outputs.task_flowpilot != 'true' }}
        run: echo "No FlowPilot changes detected; skipping FlowPilot linting."

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET (from global.json)
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: App/Server/global.json

      - name: Verify .NET version
        run: dotnet --info

      - name: Lint (FlowPilot)
        run: ./build.sh LintFlowPilotVerify

  test-flowpilot:
    name: test-flowpilot
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.task_flowpilot == 'true' }}
    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
    steps:
      - name: Explain skip
        if: ${{ needs.changes.outputs.task_flowpilot != 'true' }}
        run: echo "No FlowPilot changes detected; skipping FlowPilot tests."

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET (from global.json)
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: App/Server/global.json

      - name: Verify .NET version
        run: dotnet --info

      - name: Test (FlowPilot)
        run: ./build.sh TestFlowPilot

  package:
    name: package
    runs-on: ubuntu-latest
    needs: [changes, build-client, build-server]
    if: ${{ needs.changes.outputs.client == 'true' || needs.changes.outputs.server == 'true' }}
    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET (from global.json)
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: App/Server/global.json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: App/Client/package-lock.json

      - name: Build and publish (server + client)
        run: ./build.sh build-server-publish

      - name: Upload deployment package artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: publish/
          retention-days: 7
