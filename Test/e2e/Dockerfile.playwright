# Use the official Playwright Docker image that matches our package version
FROM mcr.microsoft.com/playwright:v1.55.0-noble

# Install .NET SDK
RUN apt-get update && apt-get install -y wget && \
    wget https://packages.microsoft.com/config/ubuntu/24.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb && \
    dpkg -i packages-microsoft-prod.deb && \
    rm packages-microsoft-prod.deb && \
    apt-get update && \
    apt-get install -y dotnet-sdk-9.0 && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /tests

# Copy the test project files
COPY E2eTests/ ./

# Restore packages
RUN dotnet restore E2eTests.csproj

# Build the test project
RUN dotnet build E2eTests.csproj -c Release

# Create directories for results
RUN mkdir -p /reports/e2e/traces

# Set environment variables for headless operation
ENV CI=true
ENV PLAYWRIGHT_HEADLESS=true

# Set the entry point to run the tests
ENTRYPOINT ["dotnet", "test", "E2eTests.csproj", "-c", "Release", "--logger", "trx;LogFileName=/reports/e2e/e2e-results.trx", "--no-build", "--verbosity", "normal"]