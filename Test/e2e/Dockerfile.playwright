# Stage 1: SDK base with Playwright browser installation (cached layer)
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS sdk-base

RUN apt-get update \
    && apt-get install -y --no-install-recommends npm \
    && npx playwright@1.55.0 install chromium --only-shell \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /tests

# Stage 2: Restore dependencies
FROM sdk-base AS restore

COPY E2eTests/E2eTests.csproj E2eTests/
COPY E2eTests.Analyzers/E2eTests.Analyzers.csproj E2eTests.Analyzers/

RUN --mount=type=cache,id=nuget-http,target=/root/.local/share/NuGet/v3-cache \
    dotnet restore E2eTests.Analyzers/E2eTests.Analyzers.csproj
RUN --mount=type=cache,id=nuget-http,target=/root/.local/share/NuGet/v3-cache \
    dotnet restore E2eTests/E2eTests.csproj

# Stage 3: Build and publish
FROM restore AS build

COPY E2eTests/ E2eTests/
COPY E2eTests.Analyzers/ E2eTests.Analyzers/

RUN --mount=type=cache,id=nuget-http,target=/root/.local/share/NuGet/v3-cache \
    dotnet publish E2eTests/E2eTests.csproj -c Release -o /app/publish --no-restore

# Stage 4: Runtime image with minimal dependencies
FROM mcr.microsoft.com/dotnet/runtime:9.0 AS test

# Install only the minimal system dependencies required for Playwright Chromium
RUN apt-get update \
    && apt-get install -y libglib2.0-0 \
           libnspr4 \
           libnss3 \
           libdbus-1-3 \
           libatk1.0-0 \
           libatk-bridge2.0-0 \
           libatspi2.0-0 \
           libx11-6 \
           libxcomposite1 \
           libxdamage1 \
           libxext6 \
           libxfixes3 \
           libxrandr2 \
           libgbm1 \
           libxcb1 \
           libxkbcommon0 \
           libasound2 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY --from=sdk-base /root/.cache/ms-playwright /root/.cache/ms-playwright

COPY --from=build /app/publish .

ENV CI=true
ENV PLAYWRIGHT_HEADLESS=true

# Use the xUnit v3 in-process console runner directly
ENTRYPOINT ["/app/E2eTests", "-trx", "/Reports/Test/e2e/Results/e2e-results.trx"]
