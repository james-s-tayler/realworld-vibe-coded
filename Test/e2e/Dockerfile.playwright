# Stage 1: Base image with .NET SDK
FROM mcr.microsoft.com/playwright:v1.55.0-noble AS base

# Install .NET SDK using the official installer script
RUN curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin --install-dir /usr/share/dotnet --channel 9.0

# Add .NET to PATH
ENV PATH="/usr/share/dotnet:${PATH}"
ENV DOTNET_ROOT="/usr/share/dotnet"

WORKDIR /tests

# Stage 2: Restore dependencies
FROM base AS restore

# Copy project files for dependency resolution
COPY E2eTests/E2eTests.csproj E2eTests/
COPY E2eTests.Analyzers/E2eTests.Analyzers.csproj E2eTests.Analyzers/

# Restore NuGet packages for both projects
RUN dotnet restore E2eTests.Analyzers/E2eTests.Analyzers.csproj
RUN dotnet restore E2eTests/E2eTests.csproj

# Stage 3: Build
FROM restore AS build

# Copy all test source files
COPY E2eTests/ E2eTests/
COPY E2eTests.Analyzers/ E2eTests.Analyzers/

# Build the project (restore will use cached packages)
RUN dotnet build E2eTests/E2eTests.csproj -c Release

# Stage 4: Test
FROM build AS test

# Set environment variables for headless operation
ENV CI=true
ENV PLAYWRIGHT_HEADLESS=true

# Copy the test runner script
COPY run-tests.sh /tests/run-tests.sh
RUN chmod +x /tests/run-tests.sh

# Set the entry point to run tests using the script (supports sharding via SHARD and SHARD_TOTAL env vars)
ENTRYPOINT ["/tests/run-tests.sh"]