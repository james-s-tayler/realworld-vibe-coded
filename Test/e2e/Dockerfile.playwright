# Use Ubuntu with .NET SDK
FROM mcr.microsoft.com/dotnet/sdk:9.0

# Install system dependencies for Playwright
RUN apt-get update && apt-get install -y \
    libnss3 \
    libatk-bridge2.0-0 \
    libdrm2 \
    libgtk-3-0 \
    libgbm1 \
    libasound2 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /tests

# Copy the test project files
COPY E2eTests/ ./

# Restore packages
RUN dotnet restore E2eTests.csproj

# Install Playwright browsers
RUN pwsh bin/Debug/net9.0/playwright.ps1 install --with-deps

# Build the test project
RUN dotnet build E2eTests.csproj -c Release

# Create directories for results
RUN mkdir -p /TestResults/traces

# Set environment variables for headless operation
ENV CI=true
ENV PLAYWRIGHT_HEADLESS=true

# Set the entry point to run the tests
ENTRYPOINT ["dotnet", "test", "E2eTests.csproj", "-c", "Release", "--logger", "trx;LogFileName=/TestResults/e2e-results.trx", "--no-build", "--verbosity", "normal"]