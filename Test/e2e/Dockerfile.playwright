# Use the official .NET 9 SDK image
FROM mcr.microsoft.com/dotnet/sdk:9.0

# Install Node.js and Playwright dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    gnupg \
    && curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /tests

# Copy the test project files
COPY E2eTests/ ./

# Restore packages
RUN dotnet restore E2eTests.csproj

# Install Playwright and its dependencies
RUN dotnet tool install --global Microsoft.Playwright.CLI
ENV PATH="${PATH}:/root/.dotnet/tools"
RUN playwright install --with-deps chromium

# Build the test project
RUN dotnet build E2eTests.csproj -c Release

# Create directories for results
RUN mkdir -p /TestResults/traces

# Set the entry point to run the tests
ENTRYPOINT ["dotnet", "test", "E2eTests.csproj", "-c", "Release", "--logger", "trx;LogFileName=/TestResults/e2e-results.trx", "--no-build", "--verbosity", "normal"]