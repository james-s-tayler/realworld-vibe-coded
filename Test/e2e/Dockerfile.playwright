# Start with dotnet SDK for better layer caching
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS base

# Install npm and Playwright browsers first (stable layer for caching)
# Install only headless Chromium shell with minimal system dependencies
# This significantly reduces image size compared to installing all browsers
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        npm \
        libnspr4 \
        libnss3 \
        libatk1.0-0 \
        libatk-bridge2.0-0 \
        libatspi2.0-0 \
        libxdamage1 \
        libxkbcommon0 \
        libasound2 \
        libxcomposite1 \
        libxfixes3 \
        libxrandr2 \
        libgbm1 \
        libcups2 \
        libdrm2 \
        libpango-1.0-0 \
        libcairo2 \
        libdbus-1-3 \
        libexpat1 \
        libfontconfig1 \
        libgcc-s1 \
        libglib2.0-0 \
        libx11-6 \
        libx11-xcb1 \
        libxcb1 \
        libxext6 \
        fonts-liberation \
        fonts-noto-color-emoji \
        fonts-freefont-ttf \
    && npx playwright@1.55.0 install chromium --only-shell \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /tests

FROM base AS restore

COPY E2eTests/E2eTests.csproj E2eTests/
COPY E2eTests.Analyzers/E2eTests.Analyzers.csproj E2eTests.Analyzers/

# Restore NuGet packages for both projects with cache mount for HTTP cache
# For some reason dotnet test seems to need to cache the nuget packages via this http cache
RUN --mount=type=cache,id=nuget-http,target=/root/.local/share/NuGet/v3-cache \
    dotnet restore E2eTests.Analyzers/E2eTests.Analyzers.csproj
RUN --mount=type=cache,id=nuget-http,target=/root/.local/share/NuGet/v3-cache \
    dotnet restore E2eTests/E2eTests.csproj

FROM restore AS build

COPY E2eTests/ E2eTests/
COPY E2eTests.Analyzers/ E2eTests.Analyzers/

RUN --mount=type=cache,id=nuget-http,target=/root/.local/share/NuGet/v3-cache \
    dotnet build E2eTests/E2eTests.csproj -c Release --no-restore

FROM build AS test

ENV CI=true
ENV PLAYWRIGHT_HEADLESS=true

ENTRYPOINT ["dotnet", "test", "./E2eTests/E2eTests.csproj", "-c", "Release", "--no-build", "--logger", "trx;LogFileName=e2e-results.trx", "--results-directory", "/Reports/Test/e2e/Results", "--verbosity", "normal"]
