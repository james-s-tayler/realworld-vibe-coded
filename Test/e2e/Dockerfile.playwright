FROM mcr.microsoft.com/playwright:v1.55.0-noble AS base

RUN curl -sSL https://dot.net/v1/dotnet-install.sh | bash /dev/stdin --install-dir /usr/share/dotnet --channel 9.0

ENV PATH="/usr/share/dotnet:${PATH}"
ENV DOTNET_ROOT="/usr/share/dotnet"

WORKDIR /tests

FROM base AS restore

COPY E2eTests/E2eTests.csproj E2eTests/
COPY E2eTests.Analyzers/E2eTests.Analyzers.csproj E2eTests.Analyzers/

# Restore NuGet packages for both projects with cache mount for HTTP cache
# For some reason dotnet test seems to need to cache the nuget packages via this http cache
RUN --mount=type=cache,id=nuget-http,target=/root/.local/share/NuGet/v3-cache \
    dotnet restore E2eTests.Analyzers/E2eTests.Analyzers.csproj
RUN --mount=type=cache,id=nuget-http,target=/root/.local/share/NuGet/v3-cache \
    dotnet restore E2eTests/E2eTests.csproj

FROM restore AS build

COPY E2eTests/ E2eTests/
COPY E2eTests.Analyzers/ E2eTests.Analyzers/

RUN --mount=type=cache,id=nuget-http,target=/root/.local/share/NuGet/v3-cache \
    dotnet build E2eTests/E2eTests.csproj -c Release --no-restore

FROM build AS test

ENV CI=true
ENV PLAYWRIGHT_HEADLESS=true

ENTRYPOINT ["dotnet", "test", "./E2eTests/E2eTests.csproj", "-c", "Release", "--no-build", "--logger", "trx;LogFileName=e2e-results.trx", "--results-directory", "/Reports/Test/e2e/Results", "--verbosity", "normal"]
